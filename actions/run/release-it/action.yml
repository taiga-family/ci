name: Action for release
description: Action for release

inputs:
  ref:
    description: GitHub ref
    required: false
  githubToken:
    description: GitHub token
    required: true
  npmToken:
    description: NPM token
    required: false
  mode:
    description: Increment mode
    required: false
  flags:
    description: Custom flags
    required: false
    default: ''

runs:
  using: composite
  steps:
    - uses: actions/checkout@v4.2.0
      with:
        token: ${{ inputs.githubToken }}
        ref: ${{ inputs.ref || github.ref }}
        persist-credentials: false
    - uses: taiga-family/ci/actions/setup/variables@main
    - uses: taiga-family/ci/actions/setup/node@main
    - uses: taiga-family/ci/actions/setup/config/git@main
      with:
        token: ${{ inputs.githubToken }}
    - uses: taiga-family/ci/actions/setup/config/npm@main
      if: ${{ inputs.npmToken }}
      with:
        token: ${{ inputs.npmToken }}

    - shell: bash
      run: |

        export GITHUB_TOKEN="${{ inputs.githubToken }}"
        export HISTORY="$(git log $(git describe --tags --abbrev=0)..@ --no-merges --oneline --grep='^feat' --grep='^fix' --grep='^refactor' --grep='^deprecate')"

        if [[ "${{ inputs.mode }}" == "" ]]; then
          if [[ "$HISTORY" == "" ]]; then
            echo "Nothing found for release..."
            exit 0;
          else
            echo "History found: \n"
            printf '%s\n' "$HISTORY"
            echo "\n\n"
          fi;
        fi;

        if [[ "${{ inputs.mode }}" == "alpha" || "${{ inputs.mode }}" == "prerelease" ]]; then
          npx release-it --preRelease=alpha --ci ${{ inputs.flags }}
        else
          npx release-it ${{ inputs.mode }} --ci ${{ inputs.flags }}
        fi
